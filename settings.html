<!DOCTYPE html>
<html>
<head>
  <title>Settings</title>
  <link rel="stylesheet" href="css/style.css">
  <script>
    // Apply theme immediately to prevent flash of light mode
    const savedTheme = localStorage.getItem("theme") || "light";
    document.documentElement.setAttribute("data-theme", savedTheme);
  </script>
</head>
<body>
<header>
  <h1>⚙️ Settings</h1>
  <nav>
    <a href="index.html">Stats</a>
    <a href="catalogue.html">Catalogue</a>
    <a href="settings.html">Settings</a>
  </nav>
</header>

<main>
  <div class="card settings-section">
    <h2>Appearance</h2>
    <p>Choose how the app looks.</p>
    <button id="themeToggle">Toggle Dark Mode</button>
    <h3 style="margin-top:1.5rem">Primary Colour</h3>
    <div class="accent-picker" id="accentPicker"></div>
  </div>

  <div class="card settings-section">
    <h2>Data (Cloud Backup)</h2>
    <p>Export your cloud data to a JSON file or import a previous backup.</p>
    <div style="display:flex; gap:0.6rem; flex-wrap:wrap; margin-bottom:1rem;">
      <button id="exportData">Export Cloud Data</button>
      <button id="importData">Import to Cloud</button>
      <input id="importFile" type="file" accept="application/json" hidden>
    </div>
    <button id="resetData" class="danger">Delete All Cloud Data</button>
  </div>

  <div class="card settings-section">
    <h2>Account</h2>
    <p id="userEmail">Loading account info...</p>
    <button id="logoutBtn" class="danger" style="margin-top: 10px;">Log Out</button>
  </div>
</main>

<script type="module">
  import { logout, getCurrentUser, getGames, importGames, clearAllGames } from './js/data.js';

  /* ---------- ACCOUNT & INITIALIZATION ---------- */
  async function initSettings() {
    const user = await getCurrentUser();
    if (user) {
      document.getElementById('userEmail').textContent = `Logged in as: ${user.email}`;
    } else {
      window.location.href = 'login.html';
    }
  }
  initSettings();

  document.getElementById('logoutBtn').onclick = async () => {
    if (confirm("Are you sure you want to log out?")) await logout();
  };

  /* ---------- THEME & ACCENT ---------- */
  const themeToggle = document.getElementById("themeToggle");
  themeToggle.onclick = () => {
    const next = document.documentElement.getAttribute("data-theme") === "dark" ? "light" : "dark";
    localStorage.setItem("theme", next);
    document.documentElement.setAttribute("data-theme", next);
  };

  const ACCENT_COLORS = ["#e63232","#f3722c","#f8961e","#ffd043","#7fc96b","#43aa8b","#4d908e","#577590","#277da1","#90be6d"];
  const picker = document.getElementById("accentPicker");

  ACCENT_COLORS.forEach(color => {
    const swatch = document.createElement("div");
    swatch.className = "accent-swatch";
    swatch.style.background = color;
    if (localStorage.getItem("accent") === color) swatch.classList.add("active");
    
    swatch.onclick = () => {
      document.documentElement.style.setProperty("--accent", color);
      localStorage.setItem("accent", color);
      document.querySelectorAll(".accent-swatch").forEach(s => s.classList.remove("active"));
      swatch.classList.add("active");
    };
    picker.appendChild(swatch);
  });

  /* ---------- DATA MANAGEMENT ---------- */
  document.getElementById("exportData").onclick = async () => {
    const games = await getGames();
    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({ games }));
    const downloadAnchorNode = document.createElement('a');
    downloadAnchorNode.setAttribute("href", dataStr);
    downloadAnchorNode.setAttribute("download", "game_tracker_backup.json");
    document.body.appendChild(downloadAnchorNode);
    downloadAnchorNode.click();
    downloadAnchorNode.remove();
  };

  const fileInput = document.getElementById("importFile");
  document.getElementById("importData").onclick = () => fileInput.click();

  fileInput.onchange = () => {
    const file = fileInput.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = async () => {
      try {
        const data = JSON.parse(reader.result);
        const gamesToImport = data.games || [];
        if (!confirm(`Import ${gamesToImport.length} games?`)) return;
        await importGames(gamesToImport);
        location.reload();
      } catch (err) { alert("Import failed: " + err.message); }
    };
    reader.readAsText(file);
  };

  document.getElementById("resetData").onclick = async () => {
    if (confirm("Delete EVERYTHING from the server? This cannot be undone.")) {
      await clearAllGames();
      location.reload();
    }
  };
</script>
<script type="module" src="js/theme.js"></script>
</body>
</html>
