<!DOCTYPE html>
<html>
<head>
  <title>Settings</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="css/style.css">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link rel="manifest" href="manifest.json">
  <script>
    const savedTheme = localStorage.getItem("theme") || "light";
    document.documentElement.setAttribute("data-theme", savedTheme);
  </script>
</head>
<body>
<header>
  <div class="header-left">
    <img src="logo.png" alt="Logo" class="site-logo" onclick="location.href='index.html'">
  </div>
  <div class="header-center">
    <h1>Settings</h1>
  </div>
  <div class="header-right">
    <nav class="desktop-nav">
      <a href="index.html">Stats</a>
      <a href="catalogue.html">Library</a>
      <a href="settings.html" class="active">Settings</a>
    </nav>
    <button class="mobile-menu-btn" id="mobileMenuBtn">â˜°</button>
  </div>
</header>

<div class="mobile-nav-overlay" id="mobileNav">
  <a href="index.html">Stats</a>
  <a href="catalogue.html">Library</a>
  <a href="settings.html">Settings</a>
</div>

<main>
  <div class="card settings-section">
    <div class="settings-header">
        <h2>Appearance</h2>
    </div>
    <div class="settings-item" style="border-bottom: none;">
        <span>Dark Mode</span>
        <button id="themeToggle" class="secondary">Toggle Theme</button>
    </div>
  </div>

  <div class="card settings-section">
    <div class="settings-header">
        <h2>Data Management</h2>
        <p style="font-size:0.85rem; color:var(--subtext); margin:0;">Backup and restore your library.</p>
    </div>
    <div class="settings-item">
        <span>Export Backup</span>
        <button id="exportData" class="secondary">Download</button>
    </div>
    <div class="settings-item">
        <span>Import Backup</span>
        <button id="importData" class="secondary">Upload</button>
        <input id="importFile" type="file" accept="application/json" hidden>
    </div>
    <div class="settings-item" style="border-bottom: none;">
        <span style="color:var(--danger)">Reset Library</span>
        <button id="resetData" class="danger">Delete All</button>
    </div>
  </div>

  <div class="card settings-section">
    <div class="settings-header">
        <h2>Account</h2>
    </div>
    <div class="settings-item" style="border-bottom: none;">
        <span id="userEmail" style="color:var(--subtext)">Loading...</span>
        <button id="logoutBtn" class="secondary" style="color:var(--danger)">Log Out</button>
    </div>
  </div>
</main>

<script type="module">
  import { logout, getCurrentUser, getGames, importGames, clearAllGames } from './js/data.js';

  window.addEventListener('DOMContentLoaded', async () => {
      // Init User
      const user = await getCurrentUser();
      if (user) {
        document.getElementById('userEmail').textContent = user.email;
      } else {
        window.location.href = 'login.html';
      }

      // Logout
      document.getElementById('logoutBtn').onclick = async () => {
        if (confirm("Log out now?")) await logout();
      };

      // Theme
      const themeToggle = document.getElementById("themeToggle");
      themeToggle.onclick = () => {
        const next = document.documentElement.getAttribute("data-theme") === "dark" ? "light" : "dark";
        localStorage.setItem("theme", next);
        document.documentElement.setAttribute("data-theme", next);
      };

      // Data Backup
      document.getElementById("exportData").onclick = async () => {
        const games = await getGames();
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({ games }));
        const dl = document.createElement('a');
        dl.setAttribute("href", dataStr);
        dl.setAttribute("download", "tracker_backup.json");
        dl.click();
      };

      const fileInput = document.getElementById("importFile");
      document.getElementById("importData").onclick = () => fileInput.click();

      fileInput.onchange = () => {
        const file = fileInput.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = async () => {
          try {
            const data = JSON.parse(reader.result);
            if (!confirm(`Import ${data.games?.length || 0} games?`)) return;
            await importGames(data.games || []);
            location.reload();
          } catch (err) { alert("Import failed"); }
        };
        reader.readAsText(file);
      };

      document.getElementById("resetData").onclick = async () => {
        if (confirm("Delete EVERYTHING?")) {
          await clearAllGames();
          location.reload();
        }
      };
  });
</script>
<script type="module" src="js/theme.js"></script>
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js');
  }
</script>
</body>
</html>
