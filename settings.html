<!DOCTYPE html>
<html>
<head>
  <title>Settings</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="css/style.css">
  <script>
    const savedTheme = localStorage.getItem("theme") || "light";
    document.documentElement.setAttribute("data-theme", savedTheme);
  </script>
</head>
<body>
<header>
  <h1>Settings</h1>
  <nav>
    <a href="index.html">Stats</a>
    <a href="catalogue.html">Library</a>
    <a href="settings.html" class="active">Settings</a>
  </nav>
</header>

<main>
  <div class="card settings-section">
    <div class="settings-header">
        <h2>Appearance</h2>
    </div>
    <div class="settings-item">
        <span>Dark Mode</span>
        <button id="themeToggle" class="secondary">Toggle</button>
    </div>
    <div class="settings-header">
        <span style="font-size:0.8rem; text-transform:uppercase; color:var(--subtext); font-weight:600;">Accent Color</span>
    </div>
    <div class="accent-picker" id="accentPicker"></div>
  </div>

  <div class="card settings-section">
    <div class="settings-header">
        <h2>Data Management</h2>
        <p style="font-size:0.85rem; color:var(--subtext); margin:0;">Backup and restore your library.</p>
    </div>
    <div class="settings-item">
        <span>Export Backup</span>
        <button id="exportData" class="secondary">Download</button>
    </div>
    <div class="settings-item">
        <span>Import Backup</span>
        <button id="importData" class="secondary">Upload</button>
        <input id="importFile" type="file" accept="application/json" hidden>
    </div>
    <div class="settings-item">
        <span style="color:var(--danger)">Reset Library</span>
        <button id="resetData" class="danger">Delete All</button>
    </div>
  </div>

  <div class="card settings-section">
    <div class="settings-header">
        <h2>Account</h2>
    </div>
    <div class="settings-item">
        <span id="userEmail" style="color:var(--subtext)">Loading...</span>
        <button id="logoutBtn" style="background:rgba(120,120,128,0.2); color:var(--text)">Log Out</button>
    </div>
  </div>
</main>

<script type="module">
  import { logout, getCurrentUser, getGames, importGames, clearAllGames } from './js/data.js';

  async function initSettings() {
    const user = await getCurrentUser();
    if (user) {
      document.getElementById('userEmail').textContent = user.email;
    } else {
      window.location.href = 'login.html';
    }
  }
  initSettings();

  document.getElementById('logoutBtn').onclick = async () => {
    if (confirm("Log out now?")) await logout();
  };

  const themeToggle = document.getElementById("themeToggle");
  themeToggle.onclick = () => {
    const next = document.documentElement.getAttribute("data-theme") === "dark" ? "light" : "dark";
    localStorage.setItem("theme", next);
    document.documentElement.setAttribute("data-theme", next);
  };

  const ACCENT_COLORS = ["#007AFF", "#FF3B30", "#FF9500", "#34C759", "#AF52DE", "#5856D6", "#FF2D55", "#A2845E"];
  const picker = document.getElementById("accentPicker");

  ACCENT_COLORS.forEach(color => {
    const swatch = document.createElement("div");
    swatch.className = "accent-swatch";
    swatch.style.background = color;
    if (localStorage.getItem("accent") === color) swatch.classList.add("active");
    
    swatch.onclick = () => {
      document.documentElement.style.setProperty("--accent", color);
      localStorage.setItem("accent", color);
      document.querySelectorAll(".accent-swatch").forEach(s => s.classList.remove("active"));
      swatch.classList.add("active");
      
      // Update accent RGB for transparencies
      // Note: In a full production app we would calculate RGB values here
    };
    picker.appendChild(swatch);
  });

  document.getElementById("exportData").onclick = async () => {
    const games = await getGames();
    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({ games }));
    const dlAnchorElem = document.createElement('a');
    dlAnchorElem.setAttribute("href", dataStr);
    dlAnchorElem.setAttribute("download", "tracker_backup.json");
    dlAnchorElem.click();
  };

  const fileInput = document.getElementById("importFile");
  document.getElementById("importData").onclick = () => fileInput.click();

  fileInput.onchange = () => {
    const file = fileInput.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = async () => {
      try {
        const data = JSON.parse(reader.result);
        const gamesToImport = data.games || [];
        if (!confirm(`Import ${gamesToImport.length} games?`)) return;
        await importGames(gamesToImport);
        location.reload();
      } catch (err) { alert("Import failed"); }
    };
    reader.readAsText(file);
  };

  document.getElementById("resetData").onclick = async () => {
    if (confirm("Delete EVERYTHING? This cannot be undone.")) {
      await clearAllGames();
      location.reload();
    }
  };
</script>
<script type="module" src="js/theme.js"></script>
</body>
</html>
